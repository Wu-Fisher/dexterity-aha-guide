name: ğŸŒ Auto Translate README

on:
  # å½“ README.md å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'README.md'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ (æ›´çµæ´»çš„æ§åˆ¶)
  workflow_dispatch:
    inputs:
      force:
        description: 'å¼ºåˆ¶é‡æ–°ç¿»è¯‘ (å¿½ç•¥ç¼“å­˜)'
        required: false
        type: boolean
        default: false
      target_lang:
        description: 'ç›®æ ‡è¯­è¨€ (English/Japanese/Korean/etc.)'
        required: false
        type: string
        default: 'English'
      skip_if_recent:
        description: 'å¦‚æœè‹±æ–‡ç‰ˆåœ¨æœ€è¿‘ä¸€æ¬¡æäº¤ä¸­å·²æ›´æ–°åˆ™è·³è¿‡'
        required: false
        type: boolean
        default: true

jobs:
  translate:
    name: Translate to English
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤,ç”¨äºæ£€æµ‹å˜åŒ–

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: ğŸ” æ™ºèƒ½æ£€æŸ¥æ˜¯å¦éœ€è¦ç¿»è¯‘
        id: check_changes
        run: |
          NEED_TRANSLATE=false
          SKIP_REASON=""

          # æ£€æŸ¥1: README.md æ˜¯å¦åœ¨æœ¬æ¬¡æäº¤ä¸­æ”¹å˜
          if git diff HEAD^ HEAD --name-only | grep -q "^README.md$"; then
            echo "ğŸ“ æ£€æµ‹åˆ° README.md å·²å˜æ›´"

            # æ£€æŸ¥2: docs/en/README.md æ˜¯å¦ä¹Ÿåœ¨åŒä¸€æ¬¡æäº¤ä¸­æ”¹å˜ (è¯´æ˜ä½ æ‰‹åŠ¨æ›´æ–°äº†)
            if git diff HEAD^ HEAD --name-only | grep -q "^docs/en/README.md$"; then
              echo "ğŸ” å‘ç° docs/en/README.md ä¹Ÿåœ¨åŒæ¬¡æäº¤ä¸­æ›´æ–°"

              # æ£€æŸ¥3: åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªåŠ¨ç¿»è¯‘çš„æäº¤ (é€šè¿‡ commit message)
              COMMIT_MSG=$(git log -1 --pretty=%B)
              if echo "$COMMIT_MSG" | grep -q "Auto-translate"; then
                echo "ğŸ¤– è¿™æ˜¯è‡ªåŠ¨ç¿»è¯‘æäº¤,éœ€è¦é‡æ–°ç¿»è¯‘"
                NEED_TRANSLATE=true
              else
                echo "âœ‹ è¿™æ˜¯æ‰‹åŠ¨æ›´æ–°çš„æäº¤,è·³è¿‡è‡ªåŠ¨ç¿»è¯‘"
                SKIP_REASON="è‹±æ–‡ç‰ˆå·²åœ¨æœ¬æ¬¡æäº¤ä¸­æ‰‹åŠ¨æ›´æ–°"
                NEED_TRANSLATE=false
              fi
            else
              echo "âœ… ä»… README.md æ›´æ–°,éœ€è¦ç¿»è¯‘"
              NEED_TRANSLATE=true
            fi
          else
            echo "â­ï¸  README.md æœªå˜æ›´"
            SKIP_REASON="æºæ–‡ä»¶æœªå˜æ›´"
            NEED_TRANSLATE=false
          fi

          # æ£€æŸ¥4: å¼ºåˆ¶ç¿»è¯‘æ ‡å¿—
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            echo "ğŸš€ æ‰‹åŠ¨è§¦å‘å¼ºåˆ¶ç¿»è¯‘"
            NEED_TRANSLATE=true
            SKIP_REASON=""
          fi

          # è¾“å‡ºç»“æœ
          echo "need_translate=$NEED_TRANSLATE" >> $GITHUB_OUTPUT
          echo "skip_reason=$SKIP_REASON" >> $GITHUB_OUTPUT

          if [ "$NEED_TRANSLATE" == "true" ]; then
            echo "ğŸ¯ ç»“è®º: éœ€è¦æ‰§è¡Œç¿»è¯‘"
          else
            echo "â­ï¸  ç»“è®º: è·³è¿‡ç¿»è¯‘ (åŸå› : $SKIP_REASON)"
          fi

      - name: ğŸŒ æ‰§è¡Œç¿»è¯‘
        if: steps.check_changes.outputs.need_translate == 'true'
        env:
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          TARGET_LANG="${{ github.event.inputs.target_lang }}"
          if [ -z "$TARGET_LANG" ]; then
            TARGET_LANG="English"
          fi

          echo "ğŸš€ å¼€å§‹ç¿»è¯‘ README.md -> $TARGET_LANG"
          python scripts/translate_markdown.py \
            README.md \
            docs/en/README.md \
            --lang "$TARGET_LANG" \
            --api-base "https://api.siliconflow.cn" \
            --model "Pro/deepseek-ai/DeepSeek-V3.1-Terminus"

      - name: ğŸ“ æ›´æ–°è¯­è¨€åˆ‡æ¢é“¾æ¥
        if: steps.check_changes.outputs.need_translate == 'true'
        run: |
          # ç¡®ä¿è‹±æ–‡ç‰ˆä¸­çš„è¯­è¨€åˆ‡æ¢é“¾æ¥æ­£ç¡®
          # å°†ç›¸å¯¹è·¯å¾„ä» ./docs/en/README.md æ”¹ä¸º ../../README.md
          if [ -f docs/en/README.md ]; then
            sed -i 's|](./docs/en/README.md)|](../../README.md)|g' docs/en/README.md
            sed -i 's|](README.md)|](../../README.md)|g' docs/en/README.md
            sed -i 's|]\(./assets/|](../../assets/|g' docs/en/README.md
            echo "âœ… è¯­è¨€åˆ‡æ¢é“¾æ¥å·²æ›´æ–°"
          fi

      - name: ğŸ“Š ç¿»è¯‘è´¨é‡æ£€æŸ¥
        if: steps.check_changes.outputs.need_translate == 'true'
        run: |
          echo "ğŸ“Š ç¿»è¯‘è´¨é‡æ£€æŸ¥:"
          echo "åŸæ–‡ä»¶å¤§å°: $(wc -c < README.md) bytes"
          echo "è¯‘æ–‡ä»¶å¤§å°: $(wc -c < docs/en/README.md) bytes"
          echo "åŸæ–‡è¡Œæ•°: $(wc -l < README.md)"
          echo "è¯‘æ–‡è¡Œæ•°: $(wc -l < docs/en/README.md)"

      - name: ğŸ’¾ æäº¤ç¿»è¯‘ç»“æœ
        if: steps.check_changes.outputs.need_translate == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add docs/en/README.md

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "â­ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          else
            git commit -m "ğŸŒ Auto-translate: Update English README

            - Translated from latest Chinese version
            - Generated by GitHub Actions
            - Model: DeepSeek-V3.1-Terminus
            - API: SiliconFlow"

            echo "âœ… å˜æ›´å·²æäº¤"
          fi

      - name: ğŸš€ æ¨é€æ›´æ”¹
        if: steps.check_changes.outputs.need_translate == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: ğŸ“¢ ä»»åŠ¡æ‘˜è¦
        if: always()
        run: |
          echo "## ğŸŒ ç¿»è¯‘ä»»åŠ¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.need_translate }}" == "true" ]; then
            echo "### âœ… ç¿»è¯‘å·²æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f docs/en/README.md ]; then
              echo "- ğŸ“„ è¾“å‡ºæ–‡ä»¶: \`docs/en/README.md\`" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ“Š æ–‡ä»¶å¤§å°: $(du -h docs/en/README.md | cut -f1)" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸŒ ç›®æ ‡è¯­è¨€: ${{ github.event.inputs.target_lang || 'English' }}" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ¤– ä½¿ç”¨æ¨¡å‹: DeepSeek-V3.1-Terminus" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ”§ API æœåŠ¡: SiliconFlow" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â­ï¸ å·²è·³è¿‡ç¿»è¯‘" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**è·³è¿‡åŸå› **: ${{ steps.check_changes.outputs.skip_reason }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ **æç¤º**: å¦‚éœ€å¼ºåˆ¶ç¿»è¯‘,è¯·ä½¿ç”¨ \`workflow_dispatch\` å¹¶å‹¾é€‰ \`force\` é€‰é¡¹" >> $GITHUB_STEP_SUMMARY
          fi
